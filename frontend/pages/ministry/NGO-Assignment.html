<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGO Assignment - Ministry Dashboard</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/css/ministry.css">
</head>
<body>
    <div class="dashboard-layout">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h3>Ministry Portal</h3>
                <p>FRA Management System</p>
            </div>
            <div class="sidebar-menu">
                <a href="dashboard.html" class="menu-item">HOME</a>
                <a href="upload-patta.html" class="menu-item">Upload Patta</a>
                <a href="maps.html" class="menu-item">Maps</a>
                <a href="policy-management.html" class="menu-item">Policy Management</a>
                <a href="ngo-assignment.html" class="menu-item active">NGO Assignment</a>
                <a href="settings.html" class="menu-item">Settings</a>
            </div>
        </nav>

        <main class="main-content">
            <header class="content-header">
                <h1>NGO Assignment Management</h1>
                <div class="user-info">
                    <span id="user-email"></span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </header>

            <!-- NGO Management Section -->
            <div class="content-section">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <!-- Registered NGOs -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary-green); margin: 0;">Registered NGOs</h3>
                            <select id="ngo-status-filter" class="form-control" style="width: 150px;">
                                <option value="">All NGOs</option>
                                <option value="true">Approved</option>
                                <option value="false">Pending</option>
                            </select>
                        </div>
                        <div id="ngo-list" style="max-height: 500px; overflow-y: auto;">
                            <div style="text-align: center; color: var(--text-light); padding: 2rem;">
                                Loading NGO data...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Create Assignment -->
                    <div>
                        <h3 style="color: var(--primary-green); margin-bottom: 1.5rem;">Create New Assignment</h3>
                        <form id="assignment-form">
                            <div class="form-group">
                                <label for="assignment-ngo">Select NGO *</label>
                                <select id="assignment-ngo" name="ngoId" class="form-control" required>
                                    <option value="">Choose NGO</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="assignment-title">Assignment Title *</label>
                                <input type="text" id="assignment-title" name="title" class="form-control" required placeholder="e.g., Field Survey - Tribal Villages">
                            </div>
                            
                            <div class="form-group">
                                <label for="assignment-area">Area/District *</label>
                                <input type="text" id="assignment-area" name="area" class="form-control" required placeholder="District or specific area">
                            </div>
                            
                            <div class="form-group">
                                <label for="assignment-villages">Target Villages</label>
                                <input type="text" id="assignment-villages" name="villages" class="form-control" placeholder="Comma-separated village names">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label for="assignment-deadline">Deadline *</label>
                                    <input type="date" id="assignment-deadline" name="deadline" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="assignment-priority">Priority *</label>
                                    <select id="assignment-priority" name="priority" class="form-control" required>
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="assignment-description">Description *</label>
                                <textarea id="assignment-description" name="description" class="form-control" rows="3" required placeholder="Detailed description of the assignment"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="assignment-instructions">Instructions *</label>
                                <textarea id="assignment-instructions" name="instructions" class="form-control" rows="4" required placeholder="Specific instructions for the NGO"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="assignment-objectives">Objectives</label>
                                <textarea id="assignment-objectives" name="objectives" class="form-control" rows="3" placeholder="Key objectives to achieve (one per line)"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <span id="create-assignment-text">Create Assignment</span>
                                <span id="create-assignment-loading" class="loading" style="display: none;"></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Assignments List -->
            <div class="content-section">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <h3 style="color: var(--primary-green); margin: 0;">All Assignments</h3>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="assignment-status-filter" class="form-control" style="width: 150px;">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="overdue">Overdue</option>
                        </select>
                        <select id="assignment-priority-filter" class="form-control" style="width: 150px;">
                            <option value="">All Priority</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                        <input type="text" id="assignment-search" placeholder="Search assignments..." class="form-control" style="width: 250px;">
                    </div>
                </div>

                <div id="assignments-container">
                    <div style="text-align: center; padding: 3rem; color: var(--text-light);">
                        Loading assignments...
                    </div>
                </div>

                <div id="assignments-pagination" style="text-align: center; margin-top: 2rem;"></div>
            </div>

            <!-- Assignment Statistics -->
            <div class="content-section">
                <h3 style="color: var(--primary-green); margin-bottom: 1.5rem;">Assignment Statistics</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="total-assignments">0</h3>
                        <p>Total Assignments</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="active-assignments-stat">0</h3>
                        <p>Active Assignments</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="completed-assignments-stat">0</h3>
                        <p>Completed</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="overdue-assignments-stat">0</h3>
                        <p>Overdue</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../../assets/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || user.role !== 'ministry') {
                window.location.href = '../login.html';
                return;
            }
            
            document.getElementById('user-email').textContent = user.email;
            
            initializeAssignmentManagement();
        });

        function initializeAssignmentManagement() {
            setupFormHandlers();
            setupFilters();
            loadNGOs();
            loadAssignments();
            loadAssignmentStats();
            setMinDeadlineDate();
        }

        function setMinDeadlineDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('assignment-deadline').min = tomorrow.toISOString().split('T')[0];
        }

        function setupFormHandlers() {
            const assignmentForm = document.getElementById('assignment-form');
            assignmentForm.addEventListener('submit', handleAssignmentCreation);
        }

        async function handleAssignmentCreation(e) {
            e.preventDefault();
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            const submitText = document.getElementById('create-assignment-text');
            const submitLoading = document.getElementById('create-assignment-loading');
            
            try {
                submitText.style.display = 'none';
                submitLoading.style.display = 'inline-block';
                submitButton.disabled = true;
                
                const formData = new FormData(e.target);
                const assignmentData = {
                    ngoId: formData.get('ngoId'),
                    title: formData.get('title'),
                    area: {
                        district: formData.get('area'),
                        villages: formData.get('villages') ? formData.get('villages').split(',').map(v => v.trim()) : []
                    },
                    description: formData.get('description'),
                    instructions: formData.get('instructions'),
                    deadline: formData.get('deadline'),
                    priority: formData.get('priority'),
                    objectives: formData.get('objectives') ? formData.get('objectives').split('\n').filter(o => o.trim()) : []
                };
                
                const response = await fraSystem.apiRequest('/assignment/create', {
                    method: 'POST',
                    body: assignmentData
                });
                
                fraSystem.showNotification('Assignment created successfully!', 'success');
                e.target.reset();
                setMinDeadlineDate();
                loadAssignments();
                loadAssignmentStats();
                
            } catch (error) {
                fraSystem.showNotification('Error creating assignment: ' + error.message, 'error');
            } finally {
                submitText.style.display = 'inline';
                submitLoading.style.display = 'none';
                submitButton.disabled = false;
            }
        }

        async function loadNGOs() {
            try {
                const response = await fraSystem.apiRequest('/ngo/list?approved=true');
                displayNGOList(response.ngos);
                populateNGOSelect(response.ngos);
                
            } catch (error) {
                fraSystem.showNotification('Error loading NGOs: ' + error.message, 'error');
            }
        }

        function displayNGOList(ngos) {
            const container = document.getElementById('ngo-list');
            
            if (ngos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-light); padding: 2rem;">
                        <h4>No NGOs found</h4>
                        <p>No NGOs match the current filter criteria.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = ngos.map(ngo => `
                <div class="ngo-card" style="background: var(--light-gray); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid ${ngo.isApproved ? 'var(--primary-green)' : '#ffc107'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <h4 style="color: var(--primary-green); margin-bottom: 0.5rem;">${ngo.profile?.name || ngo.email}</h4>
                            <p style="margin-bottom: 0.5rem; color: var(--text-light);">
                                <strong>Organization:</strong> ${ngo.profile?.organization || 'Not specified'}
                            </p>
                        </div>
                        <span class="status-badge ${ngo.isApproved ? 'verified' : 'pending'}">
                            ${ngo.isApproved ? 'Approved' : 'Pending'}
                        </span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <strong>Email:</strong> ${ngo.email}
                        </div>
                        <div>
                            <strong>District:</strong> ${ngo.profile?.district || 'Not specified'}
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Area of Operation:</strong>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">${ngo.profile?.areaOfOperation || 'Not specified'}</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        ${!ngo.isApproved ? `
                            <button class="btn btn-primary btn-small" onclick="approveNGO('${ngo._id}')">Approve</button>
                            <button class="btn btn-danger btn-small" onclick="rejectNGO('${ngo._id}')">Reject</button>
                        ` : `
                            <button class="btn btn-secondary btn-small" onclick="viewNGODetails('${ngo._id}')">View Details</button>
                            <button class="btn btn-primary btn-small" onclick="createAssignmentForNGO('${ngo._id}')">Assign Task</button>
                        `}
                    </div>
                </div>
            `).join('');
        }

        function populateNGOSelect(ngos) {
            const select = document.getElementById('assignment-ngo');
            select.innerHTML = '<option value="">Choose NGO</option>';
            
            ngos.filter(ngo => ngo.isApproved).forEach(ngo => {
                const option = document.createElement('option');
                option.value = ngo._id;
                option.textContent = `${ngo.profile?.name || ngo.email} - ${ngo.profile?.district || 'No district'}`;
                select.appendChild(option);
            });
        }

        async function loadAssignments(page = 1, status = '', priority = '', search = '') {
            try {
                const params = new URLSearchParams({
                    page: page.toString(),
                    limit: '10'
                });
                
                if (status) params.append('status', status);
                if (priority) params.append('priority', priority);
                if (search) params.append('search', search);
                
                const response = await fraSystem.apiRequest(`/assignment/all?${params}`);
                displayAssignments(response.assignments);
                displayPagination(response.pagination);
                
            } catch (error) {
                fraSystem.showNotification('Error loading assignments: ' + error.message, 'error');
            }
        }

        function displayAssignments(assignments) {
            const container = document.getElementById('assignments-container');
            
            if (assignments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-light);">
                        <h4>No assignments found</h4>
                        <p>No assignments match the current filter criteria.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = assignments.map(assignment => `
                <div class="assignment-card" style="background: var(--light-gray); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid ${getPriorityColor(assignment.priority)};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <h4 style="color: var(--primary-green); margin-bottom: 0.5rem;">${assignment.title || assignment.area.district}</h4>
                            <p style="color: var(--text-light);">
                                <strong>NGO:</strong> ${assignment.assignedTo?.profile?.name || assignment.assignedTo?.email}
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <span class="status-badge status-${assignment.status}">${assignment.status.toUpperCase()}</span>
                            <br>
                            <span class="priority-badge priority-${assignment.priority}">${assignment.priority.toUpperCase()}</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <strong>Area:</strong> ${assignment.area.district}
                        </div>
                        <div>
                            <strong>Deadline:</strong> ${fraSystem.formatDate(assignment.deadline)}
                        </div>
                        <div>
                            <strong>Progress:</strong> ${assignment.progress || 0}%
                        </div>
                        <div>
                            <strong>Created:</strong> ${fraSystem.formatDate(assignment.createdAt)}
                        </div>
                    </div>
                    
                    ${assignment.description ? `
                        <div style="background: var(--white); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            <strong>Description:</strong>
                            <p style="margin: 0.5rem 0 0 0;">${assignment.description}</p>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary btn-small" onclick="viewAssignmentDetails('${assignment._id}')">View Details</button>
                        ${assignment.status === 'completed' && assignment.report ? `
                            <button class="btn btn-primary btn-small" onclick="viewReport('${assignment._id}')">View Report</button>
                        ` : ''}
                        ${assignment.status !== 'completed' ? `
                            <button class="btn btn-warning btn-small" onclick="editAssignment('${assignment._id}')">Edit</button>
                        ` : ''}
                        <button class="btn btn-danger btn-small" onclick="deleteAssignment('${assignment._id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function getPriorityColor(priority) {
            const colors = {
                low: '#28a745',
                medium: '#ffc107',
                high: '#fd7e14',
                urgent: '#dc3545'
            };
            return colors[priority] || '#6c757d';
        }

        async function loadAssignmentStats() {
            try {
                const stats = await fraSystem.apiRequest('/assignment/stats');
                
                document.getElementById('total-assignments').textContent = stats.total || 0;
                document.getElementById('active-assignments-stat').textContent = stats.active || 0;
                document.getElementById('completed-assignments-stat').textContent = stats.completed || 0;
                document.getElementById('overdue-assignments-stat').textContent = stats.overdue || 0;
                
            } catch (error) {
                fraSystem.showNotification('Error loading assignment statistics: ' + error.message, 'error');
            }
        }

        function setupFilters() {
            const statusFilter = document.getElementById('assignment-status-filter');
            const priorityFilter = document.getElementById('assignment-priority-filter');
            const searchInput = document.getElementById('assignment-search');
            const ngoStatusFilter = document.getElementById('ngo-status-filter');
            
            statusFilter.addEventListener('change', (e) => {
                loadAssignments(1, e.target.value, priorityFilter.value, searchInput.value);
            });
            
            priorityFilter.addEventListener('change', (e) => {
                loadAssignments(1, statusFilter.value, e.target.value, searchInput.value);
            });
            
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadAssignments(1, statusFilter.value, priorityFilter.value, e.target.value);
                }, 500);
            });
            
            ngoStatusFilter.addEventListener('change', (e) => {
                loadNGOsWithFilter(e.target.value);
            });
        }

        async function loadNGOsWithFilter(approved) {
            try {
                const params = approved ? `?approved=${approved}` : '';
                const response = await fraSystem.apiRequest(`/ngo/list${params}`);
                displayNGOList(response.ngos);
                
            } catch (error) {
                fraSystem.showNotification('Error loading filtered NGOs: ' + error.message, 'error');
            }
        }

        function displayPagination(pagination) {
            const container = document.getElementById('assignments-pagination');
            if (!pagination || pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<div class="pagination">';
            
            if (pagination.current > 1) {
                html += `<button class="btn btn-secondary btn-small" onclick="loadAssignments(${pagination.current - 1})">Previous</button>`;
            }
            
            for (let i = Math.max(1, pagination.current - 2); i <= Math.min(pagination.pages, pagination.current + 2); i++) {
                const isActive = i === pagination.current;
                html += `<button class="btn ${isActive ? 'btn-primary' : 'btn-secondary'} btn-small" 
                         onclick="loadAssignments(${i})" ${isActive ? 'disabled' : ''}>${i}</button>`;
            }
            
            if (pagination.current < pagination.pages) {
                html += `<button class="btn btn-secondary btn-small" onclick="loadAssignments(${pagination.current + 1})">Next</button>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Action functions
        window.approveNGO = async (ngoId) => {
            if (confirm('Are you sure you want to approve this NGO?')) {
                try {
                    await fraSystem.apiRequest(`/ngo/approve/${ngoId}`, { method: 'PUT' });
                    fraSystem.showNotification('NGO approved successfully!', 'success');
                    loadNGOs();
                } catch (error) {
                    fraSystem.showNotification('Error approving NGO: ' + error.message, 'error');
                }
            }
        };

        window.rejectNGO = async (ngoId) => {
            const reason = prompt('Please provide a reason for rejection:');
            if (reason) {
                try {
                    await fraSystem.apiRequest(`/ngo/reject/${ngoId}`, {
                        method: 'PUT',
                        body: { reason }
                    });
                    fraSystem.showNotification('NGO registration rejected.', 'success');
                    loadNGOs();
                } catch (error) {
                    fraSystem.showNotification('Error rejecting NGO: ' + error.message, 'error');
                }
            }
        };

        window.createAssignmentForNGO = (ngoId) => {
            document.getElementById('assignment-ngo').value = ngoId;
            document.getElementById('assignment-ngo').focus();
        };

        window.viewNGODetails = async (ngoId) => {
            try {
                const ngo = await fraSystem.apiRequest(`/ngo/${ngoId}`);
                alert(`NGO Details:\n\nName: ${ngo.profile?.name || 'N/A'}\nOrganization: ${ngo.profile?.organization || 'N/A'}\nEmail: ${ngo.email}\nDistrict: ${ngo.profile?.district || 'N/A'}\nArea of Operation: ${ngo.profile?.areaOfOperation || 'N/A'}\nRegistered: ${fraSystem.formatDate(ngo.createdAt)}`);
            } catch (error) {
                fraSystem.showNotification('Error loading NGO details: ' + error.message, 'error');
            }
        };

        window.viewAssignmentDetails = async (assignmentId) => {
            try {
                const assignment = await fraSystem.apiRequest(`/assignment/${assignmentId}`);
                alert(`Assignment Details:\n\nTitle: ${assignment.title || assignment.area.district}\nNGO: ${assignment.assignedTo?.profile?.name || assignment.assignedTo?.email}\nArea: ${assignment.area.district}\nDeadline: ${fraSystem.formatDate(assignment.deadline)}\nStatus: ${assignment.status}\nPriority: ${assignment.priority}\n\nDescription:\n${assignment.description}\n\nInstructions:\n${assignment.instructions}`);
            } catch (error) {
                fraSystem.showNotification('Error loading assignment details: ' + error.message, 'error');
            }
        };

        window.viewReport = async (assignmentId) => {
            try {
                const assignment = await fraSystem.apiRequest(`/assignment/${assignmentId}`);
                if (assignment.report) {
                    alert(`Field Report:\n\nSummary: ${assignment.report.summary}\n\nFindings: ${assignment.report.findings?.join(', ') || 'None'}\n\nRecommendations: ${assignment.report.recommendations?.join(', ') || 'None'}\n\nChallenges: ${assignment.report.challenges?.join(', ') || 'None'}\n\nSubmitted: ${fraSystem.formatDate(assignment.report.submittedAt)}`);
                }
            } catch (error) {
                fraSystem.showNotification('Error loading report: ' + error.message, 'error');
            }
        };

        window.editAssignment = (assignmentId) => {
            fraSystem.showNotification('Edit assignment functionality would be implemented here', 'info');
        };

        window.deleteAssignment = async (assignmentId) => {
            if (confirm('Are you sure you want to delete this assignment? This action cannot be undone.')) {
                try {
                    await fraSystem.apiRequest(`/assignment/${assignmentId}`, { method: 'DELETE' });
                    fraSystem.showNotification('Assignment deleted successfully!', 'success');
                    loadAssignments();
                    loadAssignmentStats();
                } catch (error) {
                    fraSystem.showNotification('Error deleting assignment: ' + error.message, 'error');
                }
            }
        };

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '../login.html';
        }
    </script>

    <style>
        .priority-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 0.25rem;
            display: inline-block;
        }
        
        .priority-low { background: #d4edda; color: #155724; }
        .priority-medium { background: #fff3cd; color: #856404; }
        .priority-high { background: #f8d7da; color: #721c24; }
        .priority-urgent { background: #f5c6cb; color: #721c24; }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            align-items: center;
        }
    </style>
</body>
</html>
